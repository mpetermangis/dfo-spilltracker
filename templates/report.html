
{% extends "_base.html" %}
{% block content %}

<!-- Leaflet for coordinate map preview -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
    integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
    crossorigin=""></script>

{% set title = '({{ report.spill_id}} ) Report - CCG/DFO Spill Tracker' %}

{# <script type="text/javascript" src="/static/map_init.js"></script> #}

<main id="report{{ report.spill_id}}" role="main">

<h2>Pollution Report ({{ report.report_num }})</h2>

<div class="row mb-3" id="reportView">
    <div class="col-9">
        <h3>Report Data</h3>
        <h5>General Information:</h5>
        <p>Last Updated: {{ report.last_updated_ccg }}</p>
        <p>Report #: {{ report.report_num }}</p>
        <p>Report Name: {{ report.report_name }}</p>
        <p>Update Text: {{ report.update_text }}</p>
        <p>Recorded By: {{ report.recorded_by }}</p>
        {# Timezone: #}
        <p>Report Date: {{ report.report_date_ccg }} {{ report.report_tz_ccg }}</p>
        <p>Spill Date: {{ report.spill_date_ccg }} {{ report.spill_tz_ccg }}</p>
        <hr>
        <h5>Reporter:</h5>
        <p>Name: {{ report.name_reporter }}</p>
        <p>Phone: {{ report.phone_reporter }}</p>
        <p>Email: {{ report.email_reporter }}</p>
        <hr>
        <h5>Situation Details:</h5>
        <p>Location/Position Coordinates Type: {{ report.coordinate_type }}</p>
        <p>Coordinates: {{ report.coordinates }}</p>
        {% if report.latitude and report.longitude %}
            {# Dump vars to javascript
            <script>
                saved_latitude = {{ report.latitude | tojson }}
                saved_longitude = {{ report.longitude | tojson }}
                staticMap = true
                console.log('Report has latlon: '+saved_latitude+', '+saved_longitude)
            </script>  #}
            <div id="mapid" class="mt-3 mb-3"></div>
        {% endif %}
        {# Set values for lat-lon in HTML data #}
        <div id="coordInfo" data-latitude="{{ report.latitude }}" data-longitude="{{ report.longitude }}" data-markerdrag=""></div>
        <p>Location Description: {{ report.location_description }}</p>
        <p>Pollutant: {{ report.pollutant }}</p>
        <p>Quantity: {{ report.quantity }}</p>
        <p>Quantity units: {{ report.quantity_units }}</p>
        <p>Colour and odour: {{ report.colour_odour }}</p>
        <p>Origin: {{ report.origin }}</p>
        <p>Weather: {{ report.weather }}</p>
        <p>Additional Info: {{ report.sitation_additional_info }}</p>
        <p>Response Activated: {{ report.response_activated }}</p>
        <hr>
        <h5>Vessel information:</h5>
        <p>Vessel Name: {{ report.vessel_name }}</p>
        <p>Call Sign and MMSI: {{ report.call_sign }}</p>
        <p>Overall Length (LOA): {{ report.vessel_length }}</p>
        <p>Vessel Type: {{ report.vessel_type }}</p>
        <p>Owner/Agent/Flag: {{ report.owner_agent }}</p>
        <p>Vessel Additional Info: {{ report.vessel_additional_info }}</p>
        <hr>
        <h5>Alert List:</h5>
        <p>CCG-W ER Duty Officer: {{ report.ccg_duty_officer }}</p>
        <p>TC marine Safety - Vancouver: {{ report.tc_marine_safety }}</p>
        <p>Vancouver HM: {{ report.vancouver_hm }}</p>
        <p>Area MCTS Centre: {{ report.area_mcts_centre }}</p>
        <p>DFO Public Affairs: {{ report.dfo_public_affairs }}</p>
        <p>ROC Officer: {{ report.roc_officer }}</p>

        {% if report.attachments %}
            <hr>
            <h5>Attached Files:</h5>
            <div class="ml-3">
            {% for file in report.attachments %}
                <div class="row mb-3 attach-container">
                    <img class="attach-file-icon" src="{{ url_for('static', filename=file.icon_path) }}" alt="{{ file.filename }} preview">
                    <a class="ml-3 align-self-center" href="{{ url_for('static', filename=file.url_path) }}">{{ file.filename }}</a>
                </div>
            {% endfor %}
            </div>
        {% endif %}

    </div>
    <div class="col-3">
        
        <h5>Older Versions of this report</h5>
        <p>Click on any of the timestamps below to see the state of this report at that time.</p>
        {% for ts in timestamps %}
            <p>
            <a href="{{ url_for('report.show_report', spill_id=report.spill_id, timestamp=ts.ts_url) }}">
                {{ ts.ts_ccg_format }}
            </a>
            </p>
        {% endfor %}

        <h5>Update this report</h5>
        <p>Click the button below to make changes to this report.</p>
        <div id="reportUpdateBtn">
            <a class="btn btn-primary" role="button" href="{{ url_for('report.update_report', spill_id=report.spill_id) }}">Update Report</a>
        </div>

        <h5 class="mt-3">Download report data</h5>
        <p>Click the button below to download this report as an Excel spreadsheet.</p>
        <div class="ml-auto mb-3">  
            <a class="btn btn-warning" 
                href="{{ url_for('report.export_excel', spill_id=report.spill_id, timestamp=report.last_updated_ts) }}">Export to Excel</a>
        </div>
    </div>
</div>

{# Leaflet map, if needed #}
{% if report.latitude and report.longitude %}
    <script type="text/javascript" src="/static/spill_lib.js"></script>
    <script type="text/javascript" src="/static/map_preview.js"></script>
{% endif %}

</main>

{% endblock content %}
